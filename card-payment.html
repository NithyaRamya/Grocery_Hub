<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Secure Payment â€¢ GroceryHub</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css">
  <style>
    * {
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
    }

    body {
      background-color: #8BC34A;
      color: #333;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .payment-container {
      display: flex;
      max-width: 1100px;
      width: 100%;
      background: #fff;
      border-radius: 20px;
      overflow: hidden;
    }

    .image-half {
      flex: 1;
      min-width: 400px;
      background: url('images/credit-card-machine-4577767_1280.jpg') no-repeat center center;
      background-size: cover;
      height: 500px;
    }

    .form-half {
      flex: 1;
      padding: 40px;
      background: #f7fbe9;
    }

    .form-half h2 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
      font-weight: 700;
    }

    .amount-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .amount-line a {
      color: #999;
      font-weight: 600;
      text-decoration: none;
      font-size: 14px;
    }

    .amount-line a:hover {
      text-decoration: underline;
    }

    .field-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
      color: #666;
    }

    input {
      width: 100%;
      padding: 12px 16px;
      border: none;
      border-radius: 10px;
      background: #dff1b8;
      font-size: 16px;
      color: #333;
    }

    .cvv-expiry {
      display: flex;
      gap: 20px;
    }

    .cvv-expiry input {
      flex: 1;
    }

    .pay-btn {
      background: #8BC34A;
      color: #fff;
      padding: 15px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 30px;
      width: 100%;
      cursor: pointer;
      margin-top: 30px;
      transition: background 0.3s;
    }

    .pay-btn:hover {
      background: #7aa436;
    }

    .success-message {
      display: none;
      text-align: center;
    }

    .success-message h2 {
      color: #8BC34A;
      margin-bottom: 10px;
    }

    .success-message button {
      background: #8BC34A;
      color: #fff;
      padding: 12px 24px;
      border: none;
      border-radius: 30px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      margin-top: 20px;
    }

    .success-message button:hover {
      background: #7aa436;
    }
  </style>
</head>

<body>
  <div class="payment-container">
    <div class="image-half"></div>

    <div class="form-half">
      <div class="amount-line">
        <h2 id="pay-amount">Pay Amount <span style="color:#8BC34A;"></span></h2>
        <a href="checkout.html">Cancel</a>
      </div>

      <div class="field-group">
        <label for="cardName">Card Holder Name</label>
        <input type="text" id="cardName" placeholder="John Doe" />
      </div>

      <div class="field-group">
        <label for="cardNumber">Card Number</label>
        <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19" />
      </div>

      <div class="cvv-expiry">
        <div class="field-group">
          <label for="cardExpiry">Expiry (MM/YY)</label>
          <input type="text" id="cardExpiry" placeholder="MM/YY" maxlength="5" />
        </div>
        <div class="field-group">
          <label for="cardCVV">CVV</label>
          <input type="password" id="cardCVV" placeholder="123" maxlength="3" />
        </div>
      </div>

      <button class="pay-btn" id="confirm-payment">Confirm Payment</button>

      <div class="success-message" id="payment-success">
        <h2>âœ… Payment Successful!</h2>
        <p>Redirecting to your order summary...</p>
        <button onclick="window.location.href='order-success.html'">Go to Order Summary</button>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // Display payable total
    const total = localStorage.getItem("checkoutTotal");
    document.querySelector("#pay-amount span").textContent = total ? "â‚¹" + total : "â‚¹0.00";

    const payBtn = document.getElementById("confirm-payment");
    const successBox = document.getElementById("payment-success");

    payBtn.addEventListener("click", () => {
      const name = document.getElementById("cardName").value.trim();
      const number = document.getElementById("cardNumber").value.trim();
      const expiry = document.getElementById("cardExpiry").value.trim();
      const cvv = document.getElementById("cardCVV").value.trim();

      if (!name || !number || !expiry || !cvv) {
        alert("Please fill all payment fields correctly.");
        return;
      }

      let products = [];
      const secureProducts = JSON.parse(localStorage.getItem("securedCheckoutProduct") || "null");

      if (secureProducts && secureProducts.length > 0) {
        products = secureProducts;
      } else {
        products = JSON.parse(localStorage.getItem("cart") || "[]");
      }

      if (!products || products.length === 0) {
        alert("No products found to process.");
        return;
      }

      // Normalize numeric prices
      products = products.map(p => {
        const rawPrice = p.price || p.totalPrice || "0";
        const cleanPrice = parseFloat(String(rawPrice).replace(/[â‚¹,]/g, "").trim()) || 0;
        return { ...p, numericPrice: cleanPrice };
      });

      // Save to order summary
      localStorage.setItem("orderSummary", JSON.stringify(products));

      // Clear all checkout data
      localStorage.removeItem("cart");
      localStorage.removeItem("securedCheckoutProduct");

      // Clear badge counts
      sessionStorage.removeItem("cartCount");
      const countEl = document.getElementById("cart-count");
      if (countEl) countEl.textContent = "0";

      // Add to order history
      const history = JSON.parse(localStorage.getItem("orderHistory") || "[]");
      const totalAmount = products.reduce((sum, p) => sum + (p.numericPrice * (p.quantity || 1)), 0);
      const order = { id: Date.now(), products, total: totalAmount, date: new Date().toLocaleString() };
      history.push(order);
      localStorage.setItem("orderHistory", JSON.stringify(history));

      // Show success box
      document.querySelectorAll(".form-half > *:not(#payment-success)").forEach(el => el.style.display = "none");
      successBox.style.display = "block";

      // Redirect after delay
      setTimeout(() => window.location.href = "success.html", 2000);
    });
  });
  </script>
  <!-- Leaflet Map (for location picker) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// --------------------
// USER AUTH + PROFILE
// --------------------
function getUsers() {
  return JSON.parse(localStorage.getItem("gh_users") || "{}");
}

function saveUsers(users) {
  localStorage.setItem("gh_users", JSON.stringify(users));
}

function getCurrentUser() {
  const email = localStorage.getItem("gh_current_user");
  if (!email) return null;
  const users = getUsers();
  return users[email] || null;
}

function setCurrentUser(email) {
  if (email) localStorage.setItem("gh_current_user", email);
  else localStorage.removeItem("gh_current_user");
}

// --------------------
// SIGN UP
// --------------------
function handleSignup() {
  const name = document.getElementById("signupName").value.trim();
  const email = document.getElementById("signupEmail").value.trim().toLowerCase();
  const phone = document.getElementById("signupPhone").value.trim();
  const password = document.getElementById("signupPassword").value.trim();

  if (!name || !email || !password) {
    alert("Please fill all required fields (Name, Email, Password).");
    return;
  }

  const users = getUsers();
  if (users[email]) {
    alert("User already exists. Please login instead.");
    closeModal('signupModal');
    openModal('loginModal');
    return;
  }

  users[email] = { name, email, phone, password, location: "Set your location" };
  saveUsers(users);
  setCurrentUser(email);

  alert(`Welcome, ${name}! ðŸŽ‰`);
  closeModal('signupModal');
  updateNavbar();
}

// --------------------
// LOGIN
// --------------------
function handleLogin() {
  const email = document.getElementById("loginEmail").value.trim().toLowerCase();
  const password = document.getElementById("loginPassword").value.trim();

  const users = getUsers();
  const user = users[email];

  if (!user || user.password !== password) {
    alert("Invalid email or password.");
    return;
  }

  setCurrentUser(email);
  alert(`Welcome back, ${user.name}! ðŸŒ¿`);
  closeModal('loginModal');
  updateNavbar();
}

// --------------------
// LOGOUT
// --------------------
function handleLogout() {
  setCurrentUser(null);
  updateNavbar();
  alert("You have been logged out.");
}

// --------------------
// NAVBAR UPDATE
// --------------------
function updateNavbar() {
  const user = getCurrentUser();
  const accountBtn = document.querySelector('[onclick*="accountModal"]');
  const loginBtn = document.querySelector('.login-icon .text');
  const welcomeMsg = document.getElementById('welcome-msg');
  const locSpan = document.getElementById('current-location-text');

  if (user) {
    loginBtn.textContent = "Logout";
    loginBtn.parentElement.onclick = handleLogout;
    if (welcomeMsg) welcomeMsg.textContent = `Welcome, ${user.name}`;
    if (locSpan) locSpan.textContent = user.location || "Set your location";
  } else {
    loginBtn.textContent = "Login / Signup";
    loginBtn.parentElement.onclick = () => openModal('loginModal');
    if (welcomeMsg) welcomeMsg.textContent = "";
    if (locSpan) locSpan.textContent = "Set your location";
  }
}

document.addEventListener("DOMContentLoaded", updateNavbar);

// --------------------
// ACCOUNT MODAL FILL
// --------------------
function openAccountModal() {
  const user = getCurrentUser();
  openModal('accountModal');

  const modal = document.querySelector('#accountModal .modal');
  if (!user) {
    modal.innerHTML = `
      <span class="close-btn" onclick="closeModal('accountModal')">&times;</span>
      <h2>Not logged in</h2>
      <button onclick="openModal('loginModal'); closeModal('accountModal')">Login</button>`;
    return;
  }

  modal.innerHTML = `
    <span class="close-btn" onclick="closeModal('accountModal')">&times;</span>
    <h2>Welcome, ${user.name}</h2>
    <p><strong>Email:</strong> ${user.email}</p>
    <p><strong>Phone:</strong> ${user.phone || '-'}</p>
    <p><strong>Location:</strong> ${user.location || 'Not set'}</p>
    <hr>
    <ul>
      <li><a href="account.html">Your Account</a></li>
      <li><a href="orders.html">Your Orders</a></li>
      <li><a href="wishlist.html">Your Wishlist</a></li>
      <li><a href="saveitems.html">Subscribe & Save</a></li>
    </ul>
    <button onclick="handleLogout()">Logout</button>`;
}

// --------------------
// LOCATION PICKER MAP
// --------------------
function openLocationMap() {
  openModal('locationModal');

  // Replace modal content with map
  const modal = document.querySelector('#locationModal .modal');
  modal.innerHTML = `
    <span class="close-btn" onclick="closeModal('locationModal')">&times;</span>
    <h2>Select Your Delivery Location</h2>
    <div id="map" style="height:350px;border-radius:10px;"></div>
    <p id="pickedAddress" style="margin-top:10px;font-weight:600;color:#4a7d20;"></p>
    <button style="margin-top:10px;" onclick="closeModal('locationModal')">Done</button>
  `;

  const map = L.map('map').setView([13.0827, 80.2707], 12); // Default: Chennai
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  let marker;
  map.on('click', async (e) => {
    const { lat, lng } = e.latlng;
    if (marker) marker.remove();
    marker = L.marker([lat, lng]).addTo(map);

    // Reverse geocode
    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
    const data = await response.json();
    const address = data.display_name || `Lat: ${lat.toFixed(4)}, Lon: ${lng.toFixed(4)}`;

    document.getElementById('pickedAddress').textContent = address;

    // Save location
    const user = getCurrentUser();
    if (user) {
      const users = getUsers();
      users[user.email].location = address;
      saveUsers(users);
      updateNavbar();
    }
  });
}
</script>
<!-- Leaflet (Online Map for Location) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ---------- Modal Utilities ----------
function openModal(id){ document.getElementById(id).style.display="flex"; }
function closeModal(id){ document.getElementById(id).style.display="none"; }
function toggleModals(from,to){ closeModal(from); openModal(to); }

// ---------- Storage Helpers ----------
function getUsers(){ return JSON.parse(localStorage.getItem("gh_users")||"{}"); }
function saveUsers(u){ localStorage.setItem("gh_users",JSON.stringify(u)); }
function getCurrentUserEmail(){ return localStorage.getItem("gh_current_user"); }
function setCurrentUserEmail(e){ e?localStorage.setItem("gh_current_user",e):localStorage.removeItem("gh_current_user"); }
function getCurrentUser(){ const e=getCurrentUserEmail(); return e?getUsers()[e]||null:null; }

// ---------- Navbar Update ----------
function updateNavbar(){
  const user=getCurrentUser();
  const welcome=document.getElementById("welcome-msg");
  const loc=document.getElementById("current-location-text");
  const loginBtn=document.querySelector(".login-icon .text");
  if(user){
    if(welcome)welcome.textContent=`Welcome, ${user.name} ðŸŒ¿`;
    if(loc)loc.textContent=user.location||"Set your location";
    if(loginBtn)loginBtn.textContent="Logout";
    document.querySelector(".login-icon").onclick=handleLogout;
  }else{
    if(welcome)welcome.textContent="";
    if(loc)loc.textContent="Set your location";
    if(loginBtn)loginBtn.textContent="Login / Signup";
    document.querySelector(".login-icon").onclick=()=>openModal('loginModal');
  }
}

// ---------- Signup ----------
function handleSignup(){
  const name=signupName.value.trim();
  const email=signupEmail.value.trim().toLowerCase();
  const phone=signupPhone.value.trim();
  const password=signupPassword.value.trim();
  if(!name||!email||!password){alert("Please fill all required fields.");return;}
  const users=getUsers();
  if(users[email]){alert("User already exists. Please login.");toggleModals('signupModal','loginModal');return;}
  users[email]={name,email,phone,password,location:"Set your location"};
  saveUsers(users);
  setCurrentUserEmail(email);
  closeModal('signupModal');
  alert(`Welcome, ${name}! ðŸŽ‰`);
  updateNavbar();
}

// ---------- Login ----------
function handleLogin(){
  const email=loginEmail.value.trim().toLowerCase();
  const pass=loginPassword.value.trim();
  const users=getUsers(); const user=users[email];
  if(!user||user.password!==pass){alert("Invalid email or password.");return;}
  setCurrentUserEmail(email);
  closeModal('loginModal');
  alert(`Welcome back, ${user.name}!`);
  updateNavbar();
  updateAccountModal();
}

// ---------- Logout ----------
function handleLogout(){
  setCurrentUserEmail(null);
  updateNavbar();
  updateAccountModal();
  alert("You have been logged out.");
}

// ---------- Account Modal ----------
function updateAccountModal(){
  const user=getCurrentUser();
  const container=document.getElementById("accountContent");
  if(!user){
    container.innerHTML=`
      <h2>Your Account</h2>
      <p>You are not logged in.</p>
      <button class='continue-btn' onclick='openModal("loginModal")'>Login</button>`;
    return;
  }
  container.innerHTML=`
    <h2>Welcome, ${user.name}</h2>
    <p><strong>Email:</strong> ${user.email}</p>
    <p><strong>Phone:</strong> ${user.phone||'-'}</p>
    <p><strong>Location:</strong> ${user.location||'Not set'}</p>
    <hr>
    <ul>
      <li><a href='account.html'>Your Account</a></li>
      <li><a href='orders.html'>Your Orders</a></li>
      <li><a href='wishlist.html'>Your Wishlist</a></li>
      <li><a href='saveitems.html'>Subscribe & Save</a></li>
    </ul>
    <button class='continue-btn' onclick='openLocationMap()'>Change Location</button>
    <button class='continue-btn' onclick='handleLogout()'>Logout</button>`;
}

// ---------- Location Picker (Leaflet) ----------
function openLocationMap(){
  openModal('locationModal');
  const mapDiv=document.getElementById('map');
  mapDiv.innerHTML="";
  const map=L.map('map').setView([13.0827,80.2707],12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:19, attribution:'&copy; OpenStreetMap'
  }).addTo(map);
  let marker;
  map.on('click',async e=>{
    const{lat,lng}=e.latlng;
    if(marker)marker.remove();
    marker=L.marker([lat,lng]).addTo(map);
    const res=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
    const data=await res.json();
    const address=data.display_name||`Lat:${lat.toFixed(4)},Lon:${lng.toFixed(4)}`;
    document.getElementById('pickedAddress').textContent=address;
    const user=getCurrentUser(); if(user){
      const users=getUsers(); users[user.email].location=address; saveUsers(users);
      updateNavbar(); updateAccountModal();
    }
  });
}

// ---------- Init ----------
document.addEventListener("DOMContentLoaded",()=>{ updateNavbar(); updateAccountModal(); });
</script>

</body>
</html>
